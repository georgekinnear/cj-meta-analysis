---
title: "RQ1 and RQ2 rainclouds"
author: "Ian Jones"
date: "Feb 2023"
output:
  html_document:
    df_print: paged
---

## Setup

```{r setup, include=TRUE, attr.output='.numberLines'}
knitr::opts_chunk$set(echo = TRUE,
                      dev.args = list(png = list(type = "cairo")))
library(ggplot2)     # required to make plots
library(dplyr)       # for data wrangling/hygiene
library(viridis)     # viridis colour palettes
library(colorspace)  # colorspace colour palettes
library(ggExtra)     # to add marginal density plots & histograms
library(gghalves)    # required to make raincloud plots
library(gridExtra)   #put plots side by side
library(readr)
library(gghalves)
library(tidyverse)

# for plotting
theme_set(theme_minimal())
#library(patchwork)

# create subdirectory to store figures if it doesn't exist
#mainDir = setwd(dirname(rstudioapi::getActiveDocumentContext()$path))
#dir.create(file.path(mainDir, "figs"))

```

## Raincloud plots for RQ1 CJ META-ANALYSIS: Counts

```{r scatter, include=TRUE, attr.output='.numberLines', eval = TRUE, echo = TRUE}


rq1 <- read.csv("data/00-RQ1_table_fewercolumns.csv")
#get rid of summary stats rows
rq1 <- rq1[1:101,]
#get counts (ass, rep, comp) data
counts <- rq1[,c(1,3:5)]
counts <- pivot_longer(counts, cols = 2:4)
colnames(counts)[2] <- "key"

#choose order of x axis categories
counts$key <- factor(counts$key, levels=c('Rep', 'Comp', 'Ass'))


# Raincloud plot with repeated measurements
plotCounts <- counts %>%                 # define dataframe
  ggplot(aes(x = key,       # define x var
             y = value)) + # define y var

  #Add individual observations to the plot
  geom_point(
    position = position_jitter(width=.1), # add jitter to the observations
    alpha=.4, # set the size of each dot. alpha adds transparency
    color = "black", fill = "black") +


  #y tick labels
  scale_y_continuous(trans='log10', labels = scales::comma) +

    annotate("text", x = 3.3, y = 1000, label = "Assessors") +
    annotate("text", x = 2.3, y = 1000, label = "Comparisons") +
    annotate("text", x = 1.3, y = 1000, label = "Representations") +

  # Optional styling
  coord_flip() +                          # flip x & y coordinates
  xlab(NULL) +        # x-axis label
  ylab(NULL) + # y-axis label
  theme_minimal() +
  theme(            # make modifications to the theme
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    panel.grid.major.y=element_blank(),   # hide major grid for y axis
    panel.grid.minor.y=element_blank(),   # hide minor grid for y axis
    panel.grid.major.x=element_line(),    # show major grid for x axis
    panel.grid.minor.x=element_blank(),   # hide minor grid for x axis
    legend.position="none")


plotCounts

#ggsave("figs-pdf/FIG-RQ1_counts_raincloud.pdf", units = "cm", width = 20, height = 14)

```

## Scatterplots for RQ1:  Assessors vs Comparisons

```{r scatter_ass_comp, include=TRUE, attr.output='.numberLines', eval = TRUE, echo = TRUE}
rq1 %>%
  ggplot(aes(x = Ass, y = Comp)) +
  scale_y_continuous(trans='log10', labels = scales::comma) +
  scale_x_continuous(trans='log10', labels = scales::comma) +
#  geom_vline(xintercept = 0.7, alpha = 0.3, colour = "#CC0000") +
#  geom_hline(yintercept = 0.7, alpha = 0.3, colour = "#CC0000") +
#  geom_abline(slope = 1, intercept = 0, alpha = 0.5) +
  geom_point(alpha = 0.4) +
  geom_smooth(method = "lm", formula = "y ~ x", colour = "#003399", se = FALSE) +
 # ggpubr::stat_cor(p.accuracy = 0.001) +
  theme(aspect.ratio = 1) +
#  xlim(c(0,1)) +
#  ylim(c(0,1)) +
  labs(x = "Assessors", y = "Comparisons")
ggsave("figs-pdf/FIG-RQ1_assVScomp.pdf", units = "cm", width = 14, height = 14)
```
## Scatterplots for RQ1:  Assessors vs Representations

```{r scatter_ass_rep, include=TRUE, attr.output='.numberLines', eval = TRUE, echo = TRUE}
rq1 %>%
  ggplot(aes(x = Ass, y = Rep)) +
  scale_y_continuous(trans='log10', labels = scales::comma) +
  scale_x_continuous(trans='log10', labels = scales::comma) +
#  geom_vline(xintercept = 0.7, alpha = 0.3, colour = "#CC0000") +
#  geom_hline(yintercept = 0.7, alpha = 0.3, colour = "#CC0000") +
#  geom_abline(slope = 1, intercept = 0, alpha = 0.5) +
  geom_point(alpha = 0.4) +
  geom_smooth(method = "lm", formula = "y ~ x", colour = "#003399", se = FALSE) +
  #ggpubr::stat_cor(p.accuracy = 0.001) +
  theme(aspect.ratio = 1) +
#  xlim(c(0,1)) +
#  ylim(c(0,1)) +
  labs(x = "Assessors", y = "Representations")
#ggsave("figs-pdf/FIG-RQ1_assVSrep.pdf", units = "cm", width = 14, height = 14)
```
## Scatterplots for RQ1:  Comparisons vs Representations

```{r scatter_comp_rep, include=TRUE, attr.output='.numberLines', eval = TRUE, echo = TRUE}
rq1 %>%
  ggplot(aes(x = Comp, y = Rep)) +
  scale_y_continuous(trans='log10', labels = scales::comma) +
  scale_x_continuous(trans='log10', labels = scales::comma) +
#  geom_vline(xintercept = 0.7, alpha = 0.3, colour = "#CC0000") +
 # geom_hline(yintercept = 0.7, alpha = 0.3, colour = "#CC0000") +
#  geom_abline(slope = 1, intercept = 0, alpha = 0.5) +
  geom_point(alpha = 0.4) +
  geom_smooth(method = "lm", formula = "y ~ x", colour = "#003399", se = FALSE) +
  #ggpubr::stat_cor(p.accuracy = 0.001) +
  theme(aspect.ratio = 1) +
#  xlim(c(0,1)) +
#  ylim(c(0,1)) +
  labs(x = "Comparisons", y = "Representations")
#ggsave("figs-pdf/FIG-RQ1_compVSrep.pdf", units = "cm", width = 14, height = 14)
```

## Raincloud plot for RQ1 CJ META-ANALYSIS: Derived Counts

```{r raincloud_derived, include=TRUE, attr.output='.numberLines', eval = TRUE, echo = TRUE}
library("readr")
library("gghalves")


#get counts (ass, rep, comp) data
#counts2 <- rq1[,9:11]
#counts2 <- gather(counts2)
counts2 <- rq1[,c(1,9:11)]
counts2 <- pivot_longer(counts2, cols = 2:4)
colnames(counts2)[2] <- "key"



# Raincloud plot with repeated measurements
plotCounts2 <- counts2 %>%                 # define dataframe
  ggplot(aes(x = key,       # define x var
             y = value)) + # define y var

  #Add individual observations to the plot
  geom_point(
    position = position_jitter(width=.1), # add jitter to the observations
     alpha=.4, # set the size of each dot. alpha adds transparency
    color = "black", fill = "black") +


  #y tick labels
  scale_y_continuous(trans='log10', labels = scales::comma) +


  annotate("text", x = 3.3, y = 10, label = "Representations per assessor") +
    annotate("text", x = 2.3, y = 10, label = "Comparisons per representation") +
    annotate("text", x = 1.3, y = 10, label = "Comparisons per assessor") +

  # Optional styling
  coord_flip() +                          # flip x & y coordinates
  xlab(NULL) +        # x-axis label
  ylab(NULL) + # y-axis label
  theme_minimal() +
  theme(            # make modifications to the theme
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    panel.grid.major.y=element_blank(),   # hide major grid for y axis
    panel.grid.minor.y=element_blank(),   # hide minor grid for y axis
    panel.grid.major.x=element_line(),    # show major grid for x axis
    panel.grid.minor.x=element_line(),   # show minor grid for x axis
    legend.position="none")


plotCounts2
#ggsave("figs-pdf/FIG-RQ1_derived_counts_raincloud.pdf", units = "cm", width = 20, height = 14)
```
## Scatterplots for RQ1:  Representations per assessor vs Comparisons per representation

```{r scatter_RperA_CperR, include=TRUE, attr.output='.numberLines', eval = TRUE, echo = TRUE}
rq1 %>%
  ggplot(aes(x = repPERass, y = CompPERrep)) +
  scale_y_continuous(trans='log10', labels = scales::comma) +
  scale_x_continuous(trans='log10', labels = scales::comma) +
  #geom_vline(xintercept = 0.007, alpha = 0.3, colour = "#CC0000") +
  #geom_hline(yintercept = 0.007, alpha = 0.3, colour = "#CC0000") +
 # geom_abline(slope = -1, intercept = 0, alpha = 0.5) +
  geom_point(alpha = 0.4) +
  geom_smooth(method = "lm", formula = "y ~ x", colour = "#003399", se = FALSE) +
  #ggpubr::stat_cor(p.accuracy = 0.001) +
  theme(aspect.ratio = 1) +
#  xlim(c(0,1)) +
#  ylim(c(0,1)) +
  labs(x = "Representations per assessor", y = "Comparisons per representation")
#ggsave("figs-pdf/FIG-RQ1_repPERassVSCompPERrep.pdf", units = "cm", width = 14, height = 14)
```
## Scatterplots for RQ1: Representations per assessor vs Comparisons per assessor

```{r scatter_RperA_CperA, include=TRUE, attr.output='.numberLines', eval = TRUE, echo = TRUE}
rq1 %>%
  ggplot(aes(x = repPERass, y = CompPERass)) +
  scale_y_continuous(trans='log10', labels = scales::comma) +
  scale_x_continuous(trans='log10', labels = scales::comma) +
 # geom_vline(xintercept = 0.007, alpha = 0.3, colour = "#CC0000") +
 # geom_hline(yintercept = 0.007, alpha = 0.3, colour = "#CC0000") +
 # geom_abline(slope = 1, intercept = 0, alpha = 0.5) +
  geom_point(alpha = 0.4) +
  geom_smooth(method = "lm", formula = "y ~ x", colour = "#003399", se = FALSE) +
  #ggpubr::stat_cor(p.accuracy = 0.001) +
  theme(aspect.ratio = 1) +
#  xlim(c(0,1)) +
#  ylim(c(0,1)) +
  labs(x = "Representations per assessor", y = "Comparisons per assessor")
#ggsave("figs-pdf/FIG-RQ1_repPERassVSCompPERass.pdf", units = "cm", width = 14, height = 14)

```
## Scatterplots for RQ1: Comparisons per representation vs Comparisons per assessor

```{r scatter_CperR_CperA, include=TRUE, attr.output='.numberLines', eval = TRUE, echo = TRUE}
rq1 %>%
  ggplot(aes(x = CompPERrep, y = CompPERass)) +
  scale_y_continuous(trans='log10', labels = scales::comma) +
  scale_x_continuous(trans='log10', labels = scales::comma) +
#  geom_vline(xintercept = 0.7, alpha = 0.3, colour = "#CC0000") +
#  geom_hline(yintercept = 0.7, alpha = 0.3, colour = "#CC0000") +
#  geom_abline(slope = 1, intercept = 0, alpha = 0.5) +
  geom_point(alpha = 0.4) +
  geom_smooth(method = "lm", formula = "y ~ x", colour = "#003399", se = FALSE) +
  #ggpubr::stat_cor(p.accuracy = 0.001) +
  theme(aspect.ratio = 1) +
#  xlim(c(0,1)) +
#  ylim(c(0,1)) +
  labs(x = "Comparisons per representation", y = "Comparisons per assessor")
#ggsave("figs-pdf/FIG-RQ1_CompPERassVSCompPERrep.pdf", units = "cm", width = 14, height = 14)

```

Reliability measures raincloud with SSR based on all assessors
``` {r reliabilities_raincloud_all_assessors}

# add column of thresholds for coloring
th <- data.frame(th10=(rq1$CompPERrep > 9) * 10,
                 th20=(rq1$CompPERrep > 19) * 20 ,
                 th34=(rq1$CompPERrep > 33) * 34)
rq1$thresholds <- apply(th, 1, max, na.rm=TRUE)

#get rels columns
rels <- rq1[,c(6:8,12)]
rels <- pivot_longer(rels,
                     cols = c("SSR", "r", "Correct")
                     )
colnames(rels)[2] <- "key"
rels$thresholds <- as.character(rels$thresholds)

# Raincloud plot with repeated measurements
plotRels <- rels %>%                 # define dataframe
  ggplot(aes(x = key,       # define x var
             y = value,     # define y var
             colour = thresholds)) +

  #Add individual observations to the plot
  geom_point(
    position = position_jitter(width=.1), # add jitter to the observations
    #alpha=.8, # set the size of each dot. alpha adds transparency
    shape = 16,
    size = 3
      ) +

   scale_colour_manual(
     values = c('#bdc9e1','#74a9cf','#2b8cbe','#045a8d'),
     breaks = c("0","10","20","34"),
     labels = c("0 to 9","10 to 19","20 to 33","34 or more")
     ) +

  #y tick labels
  scale_y_continuous( labels = scales::comma) + #, minor_breaks = c(0.2, 0.3, 0.4, 0.6,0.7, 0.8, 0.9)) +

    annotate("text", x = 3.3, y = .6, label = "Scale Separation Reliability") +
    annotate("text", x = 2.3, y = .6, label = "Split-halves reliability") +
    annotate("text", x = 1.3, y = .6, label = "Correct comparisons") +
    
    annotate("text", x = 3.4, y = .1, label = "italic(n) == 101", parse=TRUE) +

  # Optional styling
  coord_flip() +                          # flip x & y coordinates
  xlab(NULL) +        # x-axis label
  ylab(NULL) + # y-axis label
  labs(colour = "Comparisons per representation") +
  theme_minimal() +
  theme(            # make modifications to the theme
    #text = element_text(size=14),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    panel.grid.major.y=element_blank(),   # hide major grid for y axis
    panel.grid.minor.y=element_blank(),   # hide minor grid for y axis
    panel.grid.major.x=element_line(),    # show major grid for x axis
    panel.grid.minor.x=element_line(),   # hide minor grid for x axis
    legend.position = "bottom"
   #legend.position= c(0.15,.8)
    )


plotRels
ggsave("figs-pdf/FIG-RQ2_reliabilities_raincloud.pdf", units = "cm", width = 20, height = 14)

```


Reliability measures raincloud with SSR based on half of assessors
``` {r reliabilities_raincloud_all_assessors_ssrx}
# get the reliability data
reliability_stats <- read_csv("data/01-meta-analysis-data.csv", show_col_types = FALSE)
#these stats contain the mean not median split-halves reliability!!!

#get the splits_stats data to get ssr_x
splits_stats <- read_csv("data-cache/split_halves_summary.csv", show_col_types = FALSE)

#we need the session data to calculate comparisons per representation for the dot colouring
session_data <- read_csv("data/00-judging_sessions_summary.csv", show_col_types = FALSE)[,c(1,3,4)]
#calculate comparisons per representation
session_data$CompPERrep <- session_data$observed_N_C / session_data$observed_N_R
# add column of thresholds
thr <- data.frame(thr10=(session_data$CompPERrep > 9) * 10,
                 thr20=(session_data$CompPERrep > 19) * 20 ,
                 thr34=(session_data$CompPERrep > 33) * 34)
session_data$thresholds <- apply(thr, 1, max, na.rm=TRUE)

#join the thresholds to reliability_stats
 reliability_stats <- full_join(session_data, reliability_stats)

#join the splits stats SSRs to the reliability stats
splits_stats_r = splits_stats %>%
  separate(file, into = c(NA, "study", NA), sep = "/") %>%
  left_join(reliability_stats, by = c("study" = "judging_session")) %>%
  filter(!str_detect(study, "Spehar")) %>%  #get rid of outlier 5 studies
  group_by(study) %>%
  summarise(ssr_x = median(ssr_x)) %>%
  filter(!is.na(ssr_x)) %>% as.data.frame

splits_stats_r <- left_join(splits_stats_r, reliability_stats, by = c("study" = "judging_session"))


#take only the columns we need from splits_stats_r 
#i.e. thresholds, ssr_x, mean_split_corr, prop_correct_judgements
splits_stats_rels <-splits_stats_r[,c(6,2,9,16)]
#make names consistent with raincloud for all judgements included in SSR
colnames(splits_stats_rels) <- c("thresholds", "SSR", "r", "Correct")

#make splits_stats_rels long
splits_stats_rels <- pivot_longer(splits_stats_rels,
                     cols = c("SSR", "r", "Correct")
                     )
colnames(splits_stats_rels)[2] <- "key"
splits_stats_rels$thresholds <- as.character(splits_stats_rels$thresholds)

# Raincloud plot with repeated measurements
plotSSrels <- splits_stats_rels %>%                 # define dataframe
  ggplot(aes(x = key,       # define x var
             y = value,     # define y var
             colour = thresholds)) +

  #Add individual observations to the plot
  geom_point(
    position = position_jitter(width=.1), # add jitter to the observations
    #alpha=.8, # set the size of each dot. alpha adds transparency
    shape = 16,
    size = 3
      ) +

   scale_colour_manual(
     values = c('#bdc9e1','#74a9cf','#2b8cbe','#045a8d'),
     breaks = c("0","10","20","34"),
     labels = c("0 to 9","10 to 19","20 to 33","34 or more")
     ) +

  #y tick labels
  scale_y_continuous( labels = scales::comma) + #, minor_breaks = c(0.2, 0.3, 0.4, 0.6,0.7, 0.8, 0.9)) +

    annotate("text", x = 3.3, y = .6, label = "Scale Separation Reliability") +
    annotate("text", x = 2.3, y = .6, label = "Split-halves reliability") +
    annotate("text", x = 1.3, y = .6, label = "Correct comparisons") +
  
    #annotate("text", x = 3.4, y = .1, label = "italic(n) == 96", parse=TRUE) +

  # Optional styling
  coord_flip() +                          # flip x & y coordinates
  xlab(NULL) +        # x-axis label
  ylab(NULL) + # y-axis label
  labs(colour = "Comparisons per representation") +
  theme_minimal() +
  theme(            # make modifications to the theme
    #text = element_text(size=14),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    panel.grid.major.y=element_blank(),   # hide major grid for y axis
    panel.grid.minor.y=element_blank(),   # hide minor grid for y axis
    panel.grid.major.x=element_line(),    # show major grid for x axis
    panel.grid.minor.x=element_line(),   # hide minor grid for x axis
    legend.position = "bottom"
   #legend.position= c(0.15,.8)
    )


plotSSrels
ggsave("figs-pdf/FIG-RQ2_reliabilities_ssrx_raincloud.pdf", units = "cm", width = 20, height = 14)

```